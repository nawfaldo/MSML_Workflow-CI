name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train_model:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure Git LFS assets are pulled
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git-lfs
          git lfs install
          git lfs fetch --all
          git lfs pull

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          
      - name: Install dependencies
        run: conda env create -f MLProject/conda.yml --name idk-env

      - name: Run MLflow project
        run: mlflow run MLProject/ --experiment-name "CI_Training" --env-manager=local

      - name: Upload MLflow run artefacts
        uses: actions/upload-artifact@v4
        with:
          name: trained_model
          path: MLProject

      - name: Build and Push Docker Image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          export PYTHONNOUSERSITE=1
          
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          
          LATEST_RUN_ID=$(ls -t mlruns/0 | head -n 1)
          
          MODEL_URI="mlruns/0/$LATEST_RUN_ID/artifacts/model"
          IMAGE_NAME="$DOCKERHUB_USERNAME/california-housing"

          conda run -n idk-env pip install --upgrade "protobuf<4" "googleapis-common-protos<2"

          DOCKER_DIR="mlflow_docker_ctx"
          rm -rf "$DOCKER_DIR"
          mkdir -p "$DOCKER_DIR/model"
          cp -r "$MODEL_URI" "$DOCKER_DIR/model"
          cat > "$DOCKER_DIR/Dockerfile" << 'EOF'
          FROM python:3.12-slim
          RUN apt-get update && apt-get install -y build-essential && rm -rf /var/lib/apt/lists/*
          ENV PYTHONUNBUFFERED=1 PYTHONNOUSERSITE=1
          WORKDIR /opt/app
          RUN pip install --no-cache-dir \
            mlflow==2.16.1 \
            pandas==2.2.0 \
            scikit-learn==1.4.0 \
            "protobuf<4" \
            "googleapis-common-protos<2"
          COPY model /opt/model
          EXPOSE 5000
          CMD ["mlflow", "models", "serve", "-m", "/opt/model", "--env-manager", "local", "--host", "0.0.0.0", "--port", "5000"]
          EOF

          docker build -t "$IMAGE_NAME:latest" "$DOCKER_DIR"
          
          docker push "$IMAGE_NAME:latest"
          
          GIT_SHA=$(git rev-parse --short HEAD)
          docker tag "$IMAGE_NAME:latest" "$IMAGE_NAME:$GIT_SHA"
          docker push "$IMAGE_NAME:$GIT_SHA"